<?php include _include(APP_PATH.'view/htm/header.inc.htm');?>

<?php
	// 公用一个模板
	if($route == 'thread' && $action == 'create') {
		$form_title = lang('thread_create');
		$form_action = url("thread-create");
		$form_submit_txt = lang('thread_create');
		$form_subject = '';
		$form_message = '';
		$form_doctype = 1;
		$isfirst = 1;
		$quotepid = 0;
		$location = url("forum-'+jfid.checked()+'");
		$filelist = array();
	} elseif($route == 'post' && $action == 'update') {
		$form_title = lang('post_update');
		$form_action = url("post-update-$pid");
		$form_submit_txt = lang('post_update');
		$form_subject = $thread['subject'];
		$form_message = $post['message'];
		$form_doctype = $post['doctype'];
		$isfirst = $post['isfirst'];
		$quotepid = $post['quotepid'];
		$location = url("thread-$tid");
	} elseif($route == 'post' && $action == 'create') {
		$form_title = lang('post_create');
		$form_action = url("post-create-$tid-0");
		$form_submit_txt = lang('post_create');
		$form_subject = '';
		$form_message = '';
		$form_doctype = 1;
		$isfirst = 0;
		//$quotepid = 0;
		$location = url("thread-$tid");
		$filelist = array();
	}
	
	
	
	$filelist += (array)_SESSION('tmp_files');
?>



<div class="row">
	<div class="col-lg-10 mx-auto">
		<div class="card">
			<div class="card-header">
				<?php echo $form_title; ?>
			</div>
			<div class="card-body">
				<form action="<?php echo $form_action;?>" method="post" id="form">
					<input type="hidden" name="doctype" value="<?php echo $form_doctype;?>" />
					<input type="hidden" name="quotepid" value="<?php echo $quotepid;?>" />
					
					
					<?php if($isfirst) { ?>
					<div class="form-group">
						
						<select class="custom-select mr-1 w-auto" name="fid">
							<?php foreach ($forumlist_allowthread as $forum) { ?>
							<option value="<?php echo $forum['fid']; ?>"><?php echo $forum['name']; ?></option>
							<?php } ?>
						</select>
						
					</div>
					
					<div class="form-group">
						<input type="text" class="form-control" placeholder="<?php echo lang('subject');?>" name="subject" value="<?php echo $form_subject;?>" id="subject">
					</div>
					
					<?php } ?>
					
					<div class="form-group">
						<textarea class="form-control" placeholder="<?php echo lang('message');?>" name="message" id="message" style="height: 300px;"><?php echo $form_message;?></textarea>
					</div>
					
					
	
					<?php if($action == 'update') { ?>
					
					<?php
						$reason = $uid == $post['last_update_uid'] ? $post['last_update_reason'] : '';
					?>
					
					<div class="form-group">
						<input type="text" class="form-control" placeholder="<?php echo lang('update_reason');?>" name="update_reason" value="<?php echo $reason;?>" maxlength="128">
					</div>
					
					<?php } ?><?php 
$kv_vcode = kv_get('vcode');
if(!empty($kv_vcode['vcode_thread_create_on']) && $route == 'thread' || !empty($kv_vcode['vcode_post_create_on']) && $route == 'post') {
?>
	<div class="media">
		<div class="media-body col-lg-3 p-0">
			<div class="form-group input-group">
				<div class="input-group-prepend">
					<span class="input-group-text"><i class="icon-barcode"></i></span>
				</div>
				<input type="text" class="form-control" placeholder="<?php echo lang('verify_code');?>" name="vcode">
			</div>
		</div>
		<div class="align-self-center ml-1">
			<div class="form-group input-group">
				<img src="<?php echo url("vcode");?>" width="150" height="32" class="vcode" onclick="this.src='<?php echo url("vcode");?>?'+Math.random();" style="cursor:pointer" title="点击更新" nofollow />
			</div>
		</div>
	</div>

<?php } ?>

					<div class="d-flex justify-content-between">
						<div class="attachlist_parent">
							<a class="small text-left" href="javascript:void(0)">
								<label class="addattach" id="addattach">
									<i class="icon-folder-open-o"></i> 
									<?php echo lang('add_attach');?>
									<input type="file"  multiple="multiple" class="invisible" />
								</label>
							</a>
							<?php echo post_file_list_html($filelist, TRUE);?>
							
						</div>
						<div class="text-right">
							<button type="submit" class="btn btn-primary" id="submit" data-loading-text="<?php echo lang('submiting');?>..."> <?php echo $form_submit_txt;?> </button>
							
						</div>
					</div>
					
					
					
				</form>
			</div>
		</div>
	</div>
</div>



<?php include _include(APP_PATH.'view/htm/footer.inc.htm');?>
<?php
$kv = kv_get('sky_content_insert_code_data');
$sky_content_insert_code_content = isset($kv['sky_content_insert_code_content']) ? $kv['sky_content_insert_code_content'] : '';
$insert_code_datas = array();
if($sky_content_insert_code_content) {
	$sky_content_insert_code_content = explode(chr(10), $sky_content_insert_code_content);
	if($sky_content_insert_code_content) {
		foreach($sky_content_insert_code_content as $key=>$val) {
			$sky_codes = explode('|', $val);
			$insert_code_datas[$sky_codes[0]] =  html_entity_decode($sky_codes[1]);
		}
	}
}
if($insert_code_datas) {
	$insert_code_datas = json_encode($insert_code_datas);
}
//var_dump( $insert_code_datas );
?>
<script>
    var jform = $('#form');
    var jsubmit = $('#submit');
    var jfid = jform.find('select[name="fid"]');
</script>

<link href="plugin/xn_umeditor/umeditor/themes/default/css/umeditor.css<?php echo $static_version;?>" type="text/css" rel="stylesheet" />
<link href="plugin/xn_umeditor/umeditor/umeditor-bbs.css<?php echo $static_version;?>" type="text/css" rel="stylesheet" />
<script type="text/javascript" src="plugin/xn_umeditor/umeditor/umeditor.config.js<?php echo $static_version;?>"></script>

<script type="text/javascript" src="plugin/xn_umeditor/umeditor/umeditor.js<?php echo $static_version;?>"></script>
<script type="text/javascript" src="plugin/xn_umeditor/umeditor/umeditor-insertcode.js<?php echo $static_version;?>"></script>
<script type="text/javascript" src="plugin/xn_umeditor/umeditor/umeditor-bbs.js<?php echo $static_version;?>"></script>
<script type="text/javascript" src="plugin/xn_umeditor/umeditor/lang/zh-cn/zh-cn.js<?php echo $static_version;?>"></script>
<script>
if(typeof jform != 'unefined') jform.find('[name="doctype"]').val(0);
var xn_sbform=$('#message').parents('form'); //获取文本框message所在form表单
xn_sbform.on('submit',function(){UM.getEditor('message').sync();}); //给submit挂载同步事件
var xn_sbdata=$._data(xn_sbform[0],'events').submit; //获取form表单submit事件列表
xn_sbdata.splice(0,0,xn_sbdata.pop()); //把同步事件优先级设到最前
</script>



<script>
(function ($) {
	$.fn.extend({
		insertAtCaret : function (myValue) {
			var $t = $(this)[0];
			if (document.selection) {
				this.focus();
				sel = document.selection.createRange();
				sel.text = myValue;
				this.focus();
			} else
			if ($t.selectionStart || $t.selectionStart == '0') {
				var startPos = $t.selectionStart;
				var endPos = $t.selectionEnd;
				var scrollTop = $t.scrollTop;
				$t.value = $t.value.substring(0, startPos) + myValue + $t.value.substring(endPos, $t.value.length);
				this.focus();
				$t.selectionStart = startPos + myValue.length;
				$t.selectionEnd = startPos + myValue.length;
				$t.scrollTop = scrollTop;
			} else {
				this.value += myValue;
				this.focus();
			}
		}
	})
})(jQuery);

jform.on('submit', function() {
	jform.reset();
	jsubmit.button('loading');
	var postdata = jform.serialize();
	$.xpost(jform.attr('action'), postdata, function(code, message) {
		if(code == 0) {
			$.alert(message);
			jsubmit.button(message).delay(1000).location('<?php echo $location;?>');
		} else if(xn.is_number(code)) {
			alert(message);
			jsubmit.button('reset');
		} else {
			$.alert(message);
			//jform.find('[name="'+code+'"]').alert(message).focus();
			jsubmit.button('reset');
		}
	});
	return false;
});

var jattachparent = $('.attachlist_parent');
$('#addattach').on('change', function(e) {
	var files = xn.get_files_from_event(e);
	if (!files) return;
	
	// 并发下会 服务端 session 写入会有问题，由客户端控制改为串行
	if (!jattachparent.find('.attachlist').length) {
		jattachparent.append('<fieldset class="fieldset"><legend><?php echo lang('uploaded_attach');?></legend><ul class="attachlist"><ul></fieldset>');
	}
	
	var jprogress = jattachparent.find('.progress');
	if(!jprogress.length) {
		jprogress = $('<div class="progress"><div class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div></div>').appendTo(jattachparent);
	}
	jprogressbar = jprogress.find('.progress-bar');

	$.each_sync(files, function(i, callback) {
		var file = files[i];
		xn.upload_file(file, xn.url('attach-create'), {is_image: 0}, function(code, message) {
			if (code != 0) return $.alert(message);
			// 把文件 append 到附件列表
			var url = message.url;
			var filetype = message.filetype;
			var aid = message.aid;
			var orgfilename = message.orgfilename;
			$('.attachlist').append('<li aid="' + aid + '"><a href="' + message.url + '" target="_blank"><i class="icon filetype ' + filetype + '"></i> ' + message.orgfilename + '</a> <a href="javascript:void(0);" class="delete ml-2"><i class="icon-remove"></i> <?php echo lang('delete');?></a></li>');
			callback();
            var sky_php_data = <?php echo $insert_code_datas;?>;
            for(var i in sky_php_data) {
                if(filetype == i) {
					var tmp_data = sky_php_data[i].replace('[url]', url);
                    //tmp_data = '<sky'+orgfilename+'>'+ tmp_data + '</sky'+orgfilename+'>';
                    tmp_data = '<sky id="sky_attr'+orgfilename+'">'+ tmp_data + '</sky>';
					if(typeof UM != 'undefined') {
                        var editor = UM.getEditor('message');
                        editor.execCommand( 'inserthtml', tmp_data);
					} else {
                        $("#message").insertAtCaret(tmp_data);
					}
                }
            }
			jprogress.hide();
		}, function(percent) {
			percent = xn.intval(percent);
			jprogressbar.css('width', percent+'%');
			jprogressbar.text(percent+'%');
			jprogress.show();
			console.log('progress:'+ percent); 
		});
	});
});

// 删除附件
jattachparent.on('click', 'a.delete', function() {
	var jlink = $(this);
	var jli = jlink.parents('li');
	var aid = jli.attr('aid');
	if(!window.confirm(lang.confirm_delete)) return false;
    if(typeof UM != 'undefined') {
        var editor = UM.getEditor('message');
        var content = editor.getContent();
	} else {
        var content = $("#message").val();
	}
    $.post(xn.url('attach-findaid-'+aid), {content:content},function(data) {
        if(typeof UM != 'undefined') {
            var editor = UM.getEditor('message');
            editor.execCommand( 'cleardoc');
            editor.execCommand( 'inserthtml', data);
		} else {
            $("#message").val(data)
		}
        $.xpost(xn.url('attach-delete-'+aid), function(code, message) {
            if(code != 0) return $.alert(message);
            jlink.parent().remove();
        });
    });

	return false;
})

jform.find('[name="fid"]').checked(<?php echo $fid;?>);

$('li[data-active="fid-<?php echo $fid;?>"]').addClass('active');

</script>


